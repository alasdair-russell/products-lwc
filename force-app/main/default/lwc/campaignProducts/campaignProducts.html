<template>
    <lightning-card title="Select Products">
        <div class="slds-p-around_medium">

            <lightning-input type="search"
                             label="Search products"
                             placeholder="Type to filter..."
                             value={query}
                             onchange={handleSearchInput}
                             oninput={handleSearchInput}>
            </lightning-input>

            <template if:true={hasSelection}>
                <div class="slds-m-top_small">
                    <span class="slds-text-title_caps">Selected ({selectedCount})</span>
                    <div class="pill-wrap">
                        <template for:each={selectedPills} for:item="pill">
                            <lightning-pill key={pill.value}
                                            label={pill.label}
                                            name={pill.value}
                                            onremove={handleRemovePill}>
                            </lightning-pill>
                        </template>
                    </div>
                </div>
            </template>

            <div class="slds-m-top_small">
                <div class="slds-grid slds-grid_align-spread slds-m-bottom_x-small">
                    <div class="slds-text-title_caps">Results ({filteredCount} shown)</div>
                    <div>
                        <lightning-button variant="neutral" label="Select all shown" onclick={handleSelectAllVisible}></lightning-button>
                        <lightning-button class="slds-m-left_x-small" variant="destructive-text" label="Clear shown" onclick={handleClearVisible}></lightning-button>
                    </div>
                </div>

                <div class="listbox scroll">
                    <template if:true={loading}>
                        <lightning-spinner alternative-text="Loading products"></lightning-spinner>
                    </template>
                    <template if:false={loading}>
                        <template for:each={filteredOptions} for:item="opt">
                            <div key={opt.value} class="row">
                                <lightning-input type="checkbox"
                                                 name="product"
                                                 label={opt.label}
                                                 checked={opt.checked}
                                                 data-value={opt.value}
                                                 onchange={handleToggleCheckbox}>
                                </lightning-input>
                            </div>
                        </template>
                        <template if:true={showTruncationNote}>
                            <div class="slds-text-color_weak slds-m-top_x-small slds-text-body_small">
                                Showing first {maxVisible} matches. Refine your search to see more.
                            </div>
                        </template>
                    </template>
                </div>
            </div>

            <div class="slds-m-top_medium slds-grid slds-grid_align-spread">
                <div>
                    <lightning-button variant="neutral" label="Reset selection" onclick={handleReset}></lightning-button>
                </div>
                <div>
                    <lightning-button variant="brand" label="Save to Campaign" onclick={handleSave} disabled={saving}></lightning-button>
                </div>
            </div>

            <template if:true={message}>
                <div class="slds-m-top_small">
                    <lightning-formatted-text value={message}></lightning-formatted-text>
                </div>
            </template>
        </div>
    </lightning-card>
</template>
